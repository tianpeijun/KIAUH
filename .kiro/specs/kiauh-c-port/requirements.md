# Klipper MCU 移植需求规格 (MVP)

## 概述

将 Klipper 3D 打印机固件的核心功能移植到单 MCU 架构，目标是**快速原型验证**，能够编译并运行基本的打印控制功能。

## 目标硬件

- **MCU**: STM32F407 / GD32H737
- **RAM**: 96KB (使用 < 40KB)
- **ROM**: 2MB (使用 < 200KB)
- **工具链**: arm-none-eabi-gcc

## MVP 范围说明

本文档只包含 MVP 阶段的需求，分为两个优先级：
- **必须** - 系统运行的基础，没有这些无法工作
- **重要** - 完整打印功能需要，但可以后续迭代

**明确不包含**：SD 卡、WiFi、CoreXY/Delta 运动学、输入整形、压力提前、自动调平、多挤出机

---

## 用户故事

### 1. 基础框架 [必须]

#### 1.1 HAL 硬件抽象层
**作为** 固件开发者
**我希望** 有统一的硬件抽象层
**以便** 复用 Klipper 现有的 src/stm32/ 代码

**验收标准**:
- [ ] 1.1.1 复用 Klipper src/stm32/gpio.c 的 GPIO 接口
- [ ] 1.1.2 复用 Klipper src/stm32/stm32f4.c 的时钟初始化
- [ ] 1.1.3 复用 Klipper src/stm32/adc.c 的 ADC 接口
- [ ] 1.1.4 复用 Klipper src/stm32/serial.c 的串口接口
- [ ] 1.1.5 代码能在 STM32F407 上编译通过

#### 1.2 系统调度器
**作为** 实时系统
**我希望** 有任务调度机制
**以便** 步进脉冲精确执行

**验收标准**:
- [ ] 1.2.1 复用 Klipper src/sched.c 调度器
- [ ] 1.2.2 支持定时器回调注册
- [ ] 1.2.3 微秒级时间戳获取

#### 1.3 串口通信
**作为** 调试人员
**我希望** 通过串口输入 G-code
**以便** 控制打印机

**验收标准**:
- [ ] 1.3.1 支持 115200 波特率
- [ ] 1.3.2 支持行缓冲输入
- [ ] 1.3.3 支持调试输出

### 2. 电机控制 [必须]

#### 2.1 步进电机驱动
**作为** 3D 打印机
**我希望** 控制步进电机
**以便** 实现运动

**验收标准**:
- [ ] 2.1.1 复用 Klipper src/stepper.c 步进驱动
- [ ] 2.1.2 支持 4 轴 (X/Y/Z/E)
- [ ] 2.1.3 最大步进频率 >= 100kHz

#### 2.2 运动规划器
**作为** 打印控制系统
**我希望** 平滑的运动规划
**以便** 打印质量良好

**验收标准**:
- [ ] 2.2.1 复用 Klipper klippy/chelper/trapq.c 梯形队列
- [ ] 2.2.2 复用 Klipper klippy/chelper/itersolve.c 迭代求解
- [ ] 2.2.3 移植 klippy/toolhead.py 核心逻辑到 C
- [ ] 2.2.4 实现梯形加速度曲线

#### 2.3 笛卡尔运动学
**作为** 笛卡尔打印机
**我希望** 坐标转换正确
**以便** G-code 映射到电机步数

**验收标准**:
- [ ] 2.3.1 复用 Klipper klippy/chelper/kin_cartesian.c
- [ ] 2.3.2 移植 klippy/kinematics/cartesian.py 配置逻辑
- [ ] 2.3.3 支持 steps/mm 配置

#### 2.4 限位开关
**作为** 打印机
**我希望** 检测限位开关
**以便** 实现归零

**验收标准**:
- [ ] 2.4.1 复用 Klipper src/endstop.c
- [ ] 2.4.2 支持 G28 归零时停止

### 3. 温度控制 [重要]

#### 3.1 温度读取
**作为** 温度监控系统
**我希望** 读取热敏电阻温度
**以便** 监控热端温度

**验收标准**:
- [ ] 3.1.1 复用 Klipper src/adccmds.c
- [ ] 3.1.2 支持 NTC 热敏电阻
- [ ] 3.1.3 温度精度 ±2°C

#### 3.2 PID 控制器
**作为** 加热控制系统
**我希望** 稳定的温度控制
**以便** 温度保持稳定

**验收标准**:
- [ ] 3.2.1 移植 klippy/extras/heaters.py 的 ControlPID 类
- [ ] 3.2.2 支持 Kp/Ki/Kd 配置
- [ ] 3.2.3 温度稳定后波动 < ±3°C

#### 3.3 加热器控制
**作为** 加热器
**我希望** PWM 控制加热功率
**以便** 调节温度

**验收标准**:
- [ ] 3.3.1 复用 Klipper src/pwmcmds.c
- [ ] 3.3.2 支持 M104/M109 指令

#### 3.4 风扇控制
**作为** 散热系统
**我希望** 控制风扇
**以便** 冷却打印件

**验收标准**:
- [ ] 3.4.1 移植 klippy/extras/fan.py 逻辑
- [ ] 3.4.2 支持 M106/M107 指令

### 4. G-code 解析 [重要]

#### 4.1 G-code 解析器
**作为** 打印控制系统
**我希望** 解析基本 G-code
**以便** 执行打印

**验收标准**:
- [ ] 4.1.1 移植 klippy/gcode.py 核心解析逻辑
- [ ] 4.1.2 支持 G0/G1 (直线运动)
- [ ] 4.1.3 支持 G28 (归零)
- [ ] 4.1.4 支持 G90/G91 (坐标模式)
- [ ] 4.1.5 支持 M104/M109 (热端温度)
- [ ] 4.1.6 支持 M106/M107 (风扇)
- [ ] 4.1.7 支持 M114 (位置查询)

### 5. 构建系统 [必须]

#### 5.1 编译构建
**作为** 开发者
**我希望** 能编译出 bin 文件
**以便** 烧录到 MCU

**验收标准**:
- [ ] 5.1.1 提供 Makefile
- [ ] 5.1.2 `make` 生成 .bin 文件
- [ ] 5.1.3 编译无错误
- [ ] 5.1.4 链接脚本正确配置 RAM/ROM

---

## 代码复用清单

| 来源 | 文件 | 用途 | 复用方式 |
|------|------|------|----------|
| src/stm32/ | stm32f4.c, gpio.c, adc.c, serial.c | HAL | 直接复用 |
| src/ | sched.c, stepper.c, endstop.c | 调度/步进 | 直接复用 |
| src/ | adccmds.c, pwmcmds.c | ADC/PWM | 直接复用 |
| klippy/chelper/ | trapq.c, itersolve.c | 运动规划 | 直接复用 |
| klippy/chelper/ | kin_cartesian.c | 运动学 | 直接复用 |
| klippy/ | toolhead.py | 运动规划 | **移植到 C** |
| klippy/ | gcode.py | G-code 解析 | **移植到 C** |
| klippy/extras/ | heaters.py | PID 控制 | **移植到 C** |
| klippy/extras/ | fan.py | 风扇控制 | **移植到 C** |

## 资源预算

| 资源 | 预算 | 说明 |
|------|------|------|
| RAM | < 40KB | 运动队列 + 缓冲区 |
| ROM | < 200KB | 代码 + 常量 |
| 新增 C 代码 | ~3,500 行 | Python 移植部分 |
| 复用 C 代码 | ~19,000 行 | Klipper 现有代码 |
